<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üèÜ GARGOLAS AWARDS 2025 üèÜ</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
  max-width:1000px;
  margin:auto;
  padding:20px;
  background:linear-gradient(135deg,#1a1a2e,#16213e,#0f0f23);
  color:#b08d32;
  min-height:100vh;
}

.container{
  background:#2d2d44;
  padding:30px;
  border-radius:20px;
  box-shadow:0 15px 40px rgba(0,0,0,.6);
}

h1{text-align:center;margin-bottom:10px;animation:pulse 2s infinite}
.subtitle{text-align:center;margin-bottom:30px}

@keyframes pulse{
  0%,100%{text-shadow:0 0 5px #b08d32}
  50%{text-shadow:0 0 20px #b08d32}
}

.hidden{display:none}

.registro{
  text-align:center;
  padding:40px;
  border:1px solid #b08d32;
  border-radius:20px;
}

input{
  padding:15px;
  margin:10px;
  width:280px;
  max-width:90vw;
  background:#1e1e2e;
  border:2px solid #505077;
  color:#b08d32;
  border-radius:12px;
  font-size:16px;
}

input:focus{outline:none;border-color:#b08d32;box-shadow:0 0 10px rgba(176,141,50,.3)}

button{
  background:linear-gradient(45deg,#9c7c19,#b08d32);
  color:#fff;
  padding:15px 30px;
  border:none;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
  transition:.3s;
  margin:5px;
}

button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 5px 15px rgba(176,141,50,.4)}
button:disabled{opacity:.4;cursor:not-allowed;background:#505077}

.user-info{text-align:center;margin-bottom:20px;font-size:18px}

.terna{
  display:none;
  background:linear-gradient(135deg,#2a2a4e,#3a2a3e);
  padding:30px;
  border-radius:20px;
  animation:fade .5s ease;
  margin:10px 0;
}

.terna.activa{display:block}

.terna-invotable{
  background:linear-gradient(135deg,#1a1a2e,#2a2a3e);
  color:#888;
  border:2px dashed #505077;
}

@keyframes fade{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}

.ternas-container {margin: 20px 0;}

.opciones{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:20px;
  min-height:120px;
  align-items:center;
  justify-content:center;
}

.opcion{
  flex:1 1 180px;
  max-width:200px;
  padding:18px;
  background:#3a3a5a;
  border-radius:15px;
  border:2px solid #505077;
  cursor:pointer;
  text-align:center;
  transition:.3s;
  font-size:14px;
  word-break:break-word;
  position: relative;
}

.opcion:hover:not(.votado):not(.disabled){border-color:#b08d32;transform:translateY(-2px)}

.opcion.votado{
  background:linear-gradient(45deg,#9c7c19,#b08d32);
  color:#fff;
  font-weight:bold;
  border-color:#fff;
}

.opcion.disabled{
  opacity:0.5;
  cursor:not-allowed;
  background:#2a2a3e;
}

.opcion.video-clip::after {
  content: "‚ñ∂";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  color: #b08d32;
  font-size: 18px;
}

.nav{
  display:flex;
  justify-content:space-between;
  margin-top:25px;
  gap:10px;
}

.stats{
  margin-top:30px;
  background:#1e1e2e;
  padding:20px;
  border-radius:15px;
  text-align:center;
  font-size:18px;
}

.progress-bar{
  width:100%;
  height:8px;
  background:#2a2a3e;
  border-radius:4px;
  overflow:hidden;
  margin:10px 0;
}

.progress-fill{
  height:100%;
  background:linear-gradient(90deg,#9c7c19,#b08d32);
  transition:width 0.3s ease;
  border-radius:4px;
}

.completado{
  background:linear-gradient(135deg,#4CAF50,#45a049);
  color:#fff;
  padding:30px;
  text-align:center;
  border-radius:20px;
  animation:fade 0.8s ease;
}

.error-msg{
  background:#ff4444;
  color:white;
  padding:15px;
  border-radius:10px;
  margin:10px 0;
  text-align:center;
  display:none;
}

.success-msg{
  background:#4CAF50;
  color:white;
  padding:15px;
  border-radius:10px;
  margin:10px 0;
  text-align:center;
  display:none;
}

/* Mini reproductor de video */
.video-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.video-modal.activo { display: flex; }

.mini-player {
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
  background: #000;
  border-radius: 15px;
  box-shadow: 0 20px 60px rgba(176,141,50,0.5);
}

.mini-player iframe {
  width: 100%;
  height: 500px;
  border-radius: 15px;
  object-fit: contain;
}

.cerrar-video {
  position: absolute;
  top: -50px;
  right: 0;
  background: #b08d32;
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 18px;
  font-weight: bold;
}

.cerrar-video:hover { background: #9c7c19; }

@media (max-width: 768px) {
  .container{padding:15px}
  input{width:90vw;max-width:300px}
  .opcion{flex:1 1 100%;max-width:100%;padding:15px;font-size:16px}
  .nav{flex-direction:column}
  .nav button{width:100%}
  .mini-player iframe { height: 60vh; }
}
</style>
</head>

<body>
<div class="container">
  <h1>üèÜ GARGOLAS AWARDS 2025 üèÜ</h1>
  <p class="subtitle">Votaci√≥n oficial ‚Äî Gargolas 2025</p>

  <div id="error-msg" class="error-msg"></div>
  <div id="success-msg" class="success-msg"></div>

  <div id="registro" class="registro">
    <h2>Registro</h2>
    <input id="nombre" placeholder="Nombre o nick" maxlength="50">
    <input id="email" placeholder="Email v√°lido (ej: usuario@dominio.com)" maxlength="100" type="email">
    <br>
    <button onclick="registrar()">üöÄ Comenzar Votaci√≥n</button>
  </div>

  <div id="votacion" class="hidden">
    <div class="user-info">
      Hola <strong><span id="usuario"></span></strong> 
      <span id="timestamp" style="font-size:14px;color:#888"></span>
    </div>

    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill" style="width:0%"></div>
    </div>
    <div class="stats">
      Votos completados: <span id="total">0</span> / <span id="total-ternas">0</span> ternas
    </div>

    <div class="ternas-container" id="ternas-container"></div>

    <div class="nav">
      <button id="volver" disabled>‚¨Ö Volver</button>
      <button id="siguiente" disabled>Siguiente ‚û°</button>
    </div>

    <div id="completado" class="completado hidden">
      <h2>üéâ ¬°Votaci√≥n Completada!</h2>
      <p>Gracias <strong id="usuario-completado"></strong> por participar en los G√°rgolas Awards 2025.</p>
      <p>Tus votos han sido registrados exitosamente en Firestore.</p>
      <button onclick="reiniciarVotacion()" style="font-size:20px;padding:20px 40px">üîÑ Nueva Votaci√≥n</button>
    </div>
  </div>

  <!-- Mini reproductor de video -->
  <div id="video-modal" class="video-modal">
    <div class="mini-player">
      <button class="cerrar-video" onclick="cerrarVideo()">‚úï</button>
      <iframe id="mini-video" frameborder="0" allowfullscreen allow="autoplay; fullscreen; picture-in-picture"></iframe>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js';
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyABUYYIU42RnSYxGL5hU4EMcvnIQ80Ycmk",
  authDomain: "gargolas-awards-2025.firebaseapp.com",
  projectId: "gargolas-awards-2025",
  storageBucket: "gargolas-awards-2025.firebasestorage.app",
  messagingSenderId: "50729106362",
  appId: "1:50729106362:web:52c2dbc0f953a27c157b83",
  measurementId: "G-WZQYR1EQ2Q"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ternasData = [
  {titulo: "MODS DEL A√ëO üëä", opciones: ["BENJAMIN142420","GERO","BRUNO","LEORAIA","MATEAKD"], votable: true},
  {titulo: "MEJOR VIEWER DEL A√ëO üîú", opciones: ["BENJAMIN142420","BRUNO","GERO","ENZO","JOACO"], votable: true},
  {titulo: "VIEWER REVELACI√ìN üî•", opciones: ["VILLAFANEXO","ENZO","TAMPA","ENZITOGOD","MACCI"], votable: true},
  {titulo: "MOD REVELACI√ìN üí£", opciones: ["BRUNO","ENZO","JOACO","AGRUCK","LEORAIA"], votable: true},
  {titulo: "MEJOR JUGADOR DE HAXBALL ‚öΩ", opciones: ["RF","ZEIKO","SANGU","ABION"], votable: true},
  {titulo: "MEJOR GK DE HAXBALL üß§", opciones: ["TELLO","NOAH","FRANCHU","GIANKISI","ZEIKO"], votable: true},
  {titulo: "PEOR JUGADOR DE HAXBALL üí©", opciones: ["BENJAMIN142420","LAMINE","COMECARNE","PALERMO","MACCI"], votable: true},
  {titulo: "TOP WATCHTIME ‚è∞", opciones: ["BENJAMIN142420","GERO","BRUNO","JOAKO","ENZO"], votable: true},
  {titulo: "MEJOR STREAMER DE LA COMUNIDAD üü¢", opciones: ["FACU","IRIONDO","TORO FUTBOL","AGRUCK","SANTI","GRIZAS","NATABENITEZZZ"], votable: true},
  {titulo: "MEJOR EDITOR üñ•Ô∏è", opciones: ["MATE","CAMINO","FRANPRODS","LEO TALLERES","FONTANA"], votable: true},
  {titulo: "TOP DONADORES üí∏", opciones: ["NICOBARI","UBI","SANTY","MAXITO","BRUNO"], votable: true},
  {titulo: "MEJOR ARTISTA DEL A√ëO üéôÔ∏è", opciones: ["LP","NAFIELD","TOUZE","DRAKO","MATEAKD"], votable: true},
  {titulo: "MEJOR CHATTER DEL A√ëO üí¨", opciones: ["JOACO","GERO","PABLITOCLIPS","ENZO","ERNESTO"], votable: true},
  {titulo: "MEJOR PJ DEL FC üôé", opciones: ["BRUNO GARGOLAS","BENJAM√çN142420","RDC","ENZO (LOS 2)","LAMINE SALADO G√ÅRGOLAS","IRIONDO G√ÅRGOLAS"], votable: true},
  {titulo: "VIEWER PROMESA DEL A√ëO üíé", opciones: ["PABLITOCLIPS","ENZITOGOD","SANTY","LAU LOPES","MACCI"], votable: true},
  {titulo: "MEJOR NOMBRE DE LA COMUNIDAD üè∑Ô∏è", opciones: ["SANGUCHITO","LAMINESALADO","FACUREIG","TRABUCODEURUGUAY","AGRUCK"], votable: true},
  {titulo: "MEJOR EDIT DEL A√ëO üëè", opciones: ["FRANPRODS","LEOTALLERES","NAXITORP","MATEAKD"], votable: true},
  {titulo: "MEJOR CLIP DEL A√ëO üìπ", 
   opciones: [
     "MauroOakd #1", 
     "Agruck #1", 
     "MauroOakd Clips", 
     "Macetaxeneize", 
     "Agruck #2", 
     "MercenarioAKD #1", 
     "MercenarioAKD #2"
   ], 
   videos: [
     "https://kick.com/maurooakd/clips/clip_01JNMS9Y68PKJ1XXHTQPP87VRQ",
     "https://kick.com/agruck/clips/clip_01KBDVE8FAAWQ4XCVEBWPW1SCZ", 
     "https://kick.com/maurooakd/clips?sort=view&range=day",
     "https://kick.com/macetaxeneize/clips/clip_01K0R3362B4BYX5T75RMVWXH1Q",
     "https://kick.com/agruck/clips/clip_01KC9YKTXFY1PA93F0GBTX42CT",
     "https://www.tiktok.com/@mercenarioakd12/video/7510801513271414072",
     "https://www.tiktok.com/@mercenarioakd12/video/7510801513271414072"
   ], 
   votable: true},
  {titulo: "VIEWER M√ÅS FACHERO DEL A√ëO üòé", opciones: ["GERO","MATEAKD"], votable: true},
  {titulo: "MEJOR TEMA DEL A√ëO üé∂", opciones: ["JOSEO NOCTURNO","WILY","TONKA","TAN MALA","COLD G√ÅRGOLA"], votable: true},
  {titulo: "VIEWER M√ÅS PLAGA üï∑Ô∏è", opciones: ["ENZO","ZEIKO","TINELPRO","NOAH","JOACO"], votable: true},
  {titulo: "MEJOR VIP DEL A√ëO üëë", opciones: ["AGUST√çNCARP","NOAH","UBI","MACCI","LAMINESALADO"], votable: true},
  {titulo: "VIEWER M√ÅS OG ‚ò†Ô∏è", opciones: ["TOUZE","FRANPRODS","NICOBARI","LUKITAS","EDAN"], votable: true},
  {titulo: "MEJOR CLIPERO DEL A√ëO üé¨", opciones: ["CLIPSZETA","MAXITO","BRUNO","MATEAKD","UBI"], votable: true},
  {titulo: "MEJOR DEFENSOR DE HAXBALL 2Ô∏è‚É£", opciones: ["ZEIKO","JOAKO"], votable: true},
  {titulo: "MEJOR MEDIO DE HAXBALL 8Ô∏è‚É£", opciones: ["LEO","TAMPA"], votable: true},
  {titulo: "MEJOR EXTREMO DE HAXBALL 7Ô∏è‚É£", opciones: ["RF","SANGU"], votable: true}
];

// Variables globales
let usuario = null;
let votos = {};
let index = 0;
let ternasElements = [];
let unsubscribe = null;

// Elementos DOM
const elementos = {
  registro: document.getElementById('registro'),
  votacion: document.getElementById('votacion'),
  usuarioSpan: document.getElementById('usuario'),
  usuarioCompletado: document.getElementById('usuario-completado'),
  ternasContainer: document.getElementById('ternas-container'),
  volverBtn: document.getElementById('volver'),
  siguienteBtn: document.getElementById('siguiente'),
  totalSpan: document.getElementById('total'),
  totalTernasSpan: document.getElementById('total-ternas'),
  progressFill: document.getElementById('progress-fill'),
  timestamp: document.getElementById('timestamp'),
  errorMsg: document.getElementById('error-msg'),
  successMsg: document.getElementById('success-msg'),
  completado: document.getElementById('completado')
};

// üî• FIRESTORE FUNCTIONS
async function guardarUsuario() {
  try {
    await setDoc(doc(db, 'usuarios', usuario.email), {
      nombre: usuario.nombre,
      email: usuario.email,
      timestamp: Date.now(),
      totalVotos: 0,
      completado: false
    });
  } catch(e) {
    console.error('Error guardando usuario:', e);
  }
}

async function guardarVotos() {
  if (!usuario) return;
  
  try {
    for (const [clave, votoDataStr] of Object.entries(votos)) {
      const votoData = typeof votoDataStr === 'string' ? JSON.parse(votoDataStr) : votoDataStr;
      await setDoc(doc(db, 'usuarios', usuario.email, 'votos', clave), {
        opcion: votoData.opcion,
        timestamp: Date.now(),
        terna: votoData.terna || ternasData[parseInt(clave.split('-')[1])]?.titulo
      });
    }
    
    const totalVotables = ternasData.filter(t => t.votable).length;
    const votosCompletados = ternasData.filter((t, i) => t.votable && votos[`${usuario.email}-${i}`]).length;
    
    await updateDoc(doc(db, 'usuarios', usuario.email), {
      totalVotos: votosCompletados,
      completado: votosCompletados === totalVotables
    });
    
    localStorage.setItem('votosGargolas', JSON.stringify(votos));
  } catch(e) {
    console.error('Error guardando votos:', e);
  }
}

async function cargarDatos() {
  const savedUser = localStorage.getItem('usuarioGargolas');
  if (!savedUser) return false;
  
  try {
    usuario = JSON.parse(savedUser);
    if (!validarUsuario(usuario)) return false;
    
    const userDoc = await getDoc(doc(db, 'usuarios', usuario.email));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      if (userData.completado) {
        mostrarError('Ya completaste tu votaci√≥n');
        return false;
      }
      
      const votosCollection = collection(db, 'usuarios', usuario.email, 'votos');
      const votosSnapshot = await getDocs(votosCollection);
      votosSnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        votos[docSnap.id] = JSON.stringify({
          opcion: data.opcion,
          timestamp: data.timestamp,
          terna: data.terna
        });
      });
    }
    
    return true;
  } catch(e) {
    console.warn('Firestore no disponible');
    return validarUsuario(usuario);
  }
}

function escucharVotosRealtime() {
  if (unsubscribe) unsubscribe();
  unsubscribe = onSnapshot(doc(db, 'usuarios', usuario.email), (docSnap) => {
    if (docSnap.exists()) {
      actualizarTodo();
    }
  });
}

// ========== APP FUNCTIONS ==========
function validarEmail(email) {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

function validarUsuario(user) {
  return user && user.nombre && user.nombre.trim() && 
         user.email && validarEmail(user.email) && 
         user.timestamp && (Date.now() - user.timestamp) < 7 * 24 * 60 * 60 * 1000;
}

window.registrar = async function() {
  const nombre = document.getElementById('nombre').value.trim();
  const email = document.getElementById('email').value.trim().toLowerCase();
  
  if (!nombre || nombre.length < 2 || !validarEmail(email)) {
    mostrarError('Completa todos los datos correctamente');
    return;
  }
  
  try {
    const docSnap = await getDoc(doc(db, 'usuarios', email));
    if (docSnap.exists() && docSnap.data().completado) {
      mostrarError('Ya completaste tu votaci√≥n anteriormente');
      return;
    }
  } catch(e) {}
  
  usuario = { nombre: nombre.substring(0, 50), email, timestamp: Date.now() };
  
  await guardarUsuario();
  localStorage.setItem('usuarioGargolas', JSON.stringify(usuario));
  
  elementos.usuarioSpan.textContent = usuario.nombre;
  elementos.usuarioCompletado.textContent = usuario.nombre;
  elementos.timestamp.textContent = '(Hoy)';
  
  mostrarSeccionVotacion();
  escucharVotosRealtime();
  mostrarExito('¬°Registro exitoso! Comienza a votar.');
}

function obtenerClaveActual() {
  return `${usuario.email}-${index}`;
}

function abrirVideo(url, opcionIndex) {
  const modal = document.getElementById('video-modal');
  const iframe = document.getElementById('mini-video');
  
  let embedUrl = url;
  
  if (url.includes('kick.com')) {
    embedUrl = url;
  } else if (url.includes('tiktok.com')) {
    embedUrl = url.replace('/video/', '/embed/');
  }
  
  iframe.src = embedUrl;
  modal.classList.add('activo');
}

window.cerrarVideo = function() {
  const modal = document.getElementById('video-modal');
  const iframe = document.getElementById('mini-video');
  
  iframe.src = '';
  modal.classList.remove('activo');
}

async function votar(opcion) {
  if (!usuario || !ternasData[index].votable) return;
  
  const clave = obtenerClaveActual();
  votos[clave] = JSON.stringify({
    opcion,
    timestamp: Date.now(),
    terna: ternasData[index].titulo
  });
  
  await guardarVotos();
  localStorage.setItem('votosGargolas', JSON.stringify(votos));
  actualizarTodo();
  mostrarExito('¬°Voto registrado!');
}

function verificarPuedeAvanzar() {
  for (let i = 0; i <= index; i++) {
    if (ternasData[i].votable && !votos[`${usuario.email}-${i}`]) {
      return false;
    }
  }
  return true;
}

function generarTernas() {
  ternasData.forEach((terna, i) => {
    const div = document.createElement('div');
    div.className = `terna ${!terna.votable ? 'terna-invotable' : ''}`;
    div.dataset.categoria = i;
    
    const opcionesHTML = terna.votable ? 
      terna.opciones.map((opcion, opcionIndex) => {
        const safeOp = opcion.replace(/[<>&"']/g, c => ({
          '<': '&lt;', '>': '&gt;', '&': '&amp;', 
          '"': '&quot;', "'": '&#x27;'
        })[c]);
        
        // Detectar si es terna de videos
        const esVideo = terna.videos && terna.videos[opcionIndex];
        const claseVideo = esVideo ? 'opcion video-clip' : 'opcion';
        const dataVideo = esVideo ? `data-video="${terna.videos[opcionIndex]}" data-index="${opcionIndex}"` : '';
        
        return `<div class="${claseVideo}" data-opcion="${safeOp}" ${dataVideo}>${opcion}</div>`;
      }).join('') : 
      '<div style="text-align:center;color:#888;font-style:italic">Terna no disponible para votar</div>';
    
    div.innerHTML = `
      <h3>${terna.titulo}</h3>
      <div class="opciones">${opcionesHTML}</div>
    `;
    
    elementos.ternasContainer.appendChild(div);
    ternasElements.push(div);
  });
}

function actualizarTodo() {
  ternasElements.forEach((t, i) => {
    t.classList.toggle('activa', i === index);
  });
  
  if (ternasElements[index]) {
    const opciones = ternasElements[index].querySelectorAll('.opcion');
    const votoActual = votos[obtenerClaveActual()];
    const votoSeleccionado = votoActual ? JSON.parse(votoActual).opcion : null;
    
    opciones.forEach(op => {
      op.classList.toggle('votado', op.dataset.opcion === votoSeleccionado);
    });
  }
  
  elementos.siguienteBtn.disabled = !verificarPuedeAvanzar() || index >= ternasData.length - 1;
  elementos.volverBtn.disabled = index === 0;
  elementos.siguienteBtn.textContent = index >= ternasData.length - 1 ? '¬°Finalizar! ‚û°' : 'Siguiente ‚û°';
  
  actualizarProgreso();
}

function actualizarProgreso() {
  const totalVotables = ternasData.filter(t => t.votable).length;
  const votosCompletados = ternasData.filter((t, i) => 
    t.votable && votos[`${usuario.email}-${i}`]
  ).length;
  
  elementos.totalSpan.textContent = votosCompletados;
  elementos.totalTernasSpan.textContent = totalVotables;
  elementos.progressFill.style.width = totalVotables ? 
    `${(votosCompletados / totalVotables) * 100}%` : '0%';
  
  if (votosCompletados === totalVotables) {
    marcarVotacionCompleta();
  }
}

async function marcarVotacionCompleta() {
  await updateDoc(doc(db, 'usuarios', usuario.email), {
    completado: true,
    fechaCompletado: Date.now()
  });
  
  elementos.votacion.querySelector('.nav').style.display = 'none';
  elementos.completado.classList.remove('hidden');
}

function mostrarSeccionVotacion() {
  elementos.registro.classList.add('hidden');
  elementos.votacion.classList.remove('hidden');
  elementos.totalTernasSpan.textContent = ternasData.filter(t => t.votable).length;
}

function mostrarError(msg) {
  elementos.errorMsg.textContent = msg;
  elementos.errorMsg.style.display = 'block';
  elementos.successMsg.style.display = 'none';
  setTimeout(() => elementos.errorMsg.style.display = 'none', 5000);
}

function mostrarExito(msg) {
  elementos.successMsg.textContent = msg;
  elementos.successMsg.style.display = 'block';
  elementos.errorMsg.style.display = 'none';
  setTimeout(() => elementos.successMsg.style.display = 'none', 3000);
}

window.reiniciarVotacion = function() {
  if (confirm('¬øSeguro que quieres reiniciar? Perder√°s tu progreso.')) {
    localStorage.removeItem('usuarioGargolas');
    localStorage.removeItem('votosGargolas');
    location.reload();
  }
}

function bindEventListeners() {
  elementos.ternasContainer.addEventListener('click', async (e) => {
    // Verificar si es un video clip
    if (e.target.classList.contains('video-clip')) {
      const videoUrl = e.target.dataset.video;
      if (videoUrl) {
        abrirVideo(videoUrl, e.target.dataset.index);
        return;
      }
    }
    
    // Voto normal
    if (e.target.classList.contains('opcion') && !e.target.classList.contains('disabled') && !e.target.classList.contains('video-clip')) {
      const opcion = e.target.dataset.opcion;
      await votar(opcion);
    }
  });

  // Cerrar modal clicando fuera
  document.getElementById('video-modal').addEventListener('click', (e) => {
    if (e.target.id === 'video-modal') cerrarVideo();
  });

  elementos.siguienteBtn.onclick = () => {
    if (index < ternasData.length - 1) {
      index++;
      actualizarTodo();
    }
  };
  
  elementos.volverBtn.onclick = () => {
    if (index > 0) {
      index--;
      actualizarTodo();
    }
  };
  
  document.getElementById('nombre').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') registrar();
  });
  document.getElementById('email').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') registrar();
  });
}

async function init() {
  await cargarDatos();
  
  if (usuario) {
    mostrarSeccionVotacion();
    elementos.usuarioSpan.textContent = usuario.nombre;
    escucharVotosRealtime();
  }
  
  generarTernas();
  bindEventListeners();
  actualizarTodo();
}

init();
</script>
</body>
</html>
